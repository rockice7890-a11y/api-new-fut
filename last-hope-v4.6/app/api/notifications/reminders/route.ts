import { type NextRequest, NextResponse } from "next/server"
import { prisma } from "@/lib/prisma"
import { withAuth } from "@/lib/middleware"
import { successResponse, failResponse } from "@/lib/api-response"
import { z } from "zod"

export const dynamic = 'force-dynamic'

const reminderSchema = z.object({
  bookingId: z.string(),
    reminderType: z.enum(['checkin', 'checkout', 'payment']),
      customMessage: z.string().optional(),
        scheduledTime: z.string().datetime().optional(),
        })

        export async function POST(req: NextRequest) {
          const auth = await withAuth(req)
            if (!auth.isValid) return auth.response!

              try {
                  const body = await req.json()
                      const validated = reminderSchema.parse(body)

                          // Verify booking exists and user has access
                              const booking = await prisma.booking.findFirst({
                                    where: {
                                            id: validated.bookingId,
                                                    OR: [
                                                              { userId: auth.payload.userId },
                                                                        { hotel: { managerId: auth.payload.userId } },
                                                                                ],
                                                                                      },
                                                                                            include: {
                                                                                                    hotel: true,
                                                                                                            user: true,
                                                                                                                  },
                                                                                                                      })

                                                                                                                          if (!booking) {
                                                                                                                                return NextResponse.json(
                                                                                                                                        failResponse(null, "Booking not found or access denied", "BOOKING_NOT_FOUND"),
                                                                                                                                                { status: 404 }
                                                                                                                                                      )
                                                                                                                                                          }

                                                                                                                                                              // Calculate reminder time based on type and booking details
                                                                                                                                                                  let scheduledTime: Date
                                                                                                                                                                      const now = new Date()

                                                                                                                                                                          switch (validated.reminderType) {
                                                                                                                                                                                case 'checkin':
                                                                                                                                                                                        // Remind 2 hours before check-in
                                                                                                                                                                                                scheduledTime = new Date(booking.checkInDate.getTime() - 2 * 60 * 60 * 1000)
                                                                                                                                                                                                        break
                                                                                                                                                                                                              case 'checkout':
                                                                                                                                                                                                                      // Remind 1 hour before checkout
                                                                                                                                                                                                                              scheduledTime = new Date(booking.checkOutDate.getTime() - 1 * 60 * 60 * 1000)
                                                                                                                                                                                                                                      break
                                                                                                                                                                                                                                            case 'payment':
                                                                                                                                                                                                                                                    // Remind 24 hours before check-in
                                                                                                                                                                                                                                                            scheduledTime = new Date(booking.checkInDate.getTime() - 24 * 60 * 60 * 1000)
                                                                                                                                                                                                                                                                    break
                                                                                                                                                                                                                                                                          default:
                                                                                                                                                                                                                                                                                  scheduledTime = validated.scheduledTime ? new Date(validated.scheduledTime) : now
                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                          // Don't schedule reminders in the past
                                                                                                                                                                                                                                                                                              if (scheduledTime <= now) {
                                                                                                                                                                                                                                                                                                    return NextResponse.json(
                                                                                                                                                                                                                                                                                                            failResponse(null, "Cannot schedule reminder in the past", "INVALID_TIME"),
                                                                                                                                                                                                                                                                                                                    { status: 400 }
                                                                                                                                                                                                                                                                                                                          )
                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                  // Check if reminder already exists
                                                                                                                                                                                                                                                                                                                                      const existingReminder = await prisma.checkoutReminder.findFirst({
                                                                                                                                                                                                                                                                                                                                            where: {
                                                                                                                                                                                                                                                                                                                                                    bookingId: validated.bookingId,
                                                                                                                                                                                                                                                                                                                                                            reminderText: validated.reminderType,
                                                                                                                                                                                                                                                                                                                                                                  },
                                                                                                                                                                                                                                                                                                                                                                      })

                                                                                                                                                                                                                                                                                                                                                                          if (existingReminder) {
                                                                                                                                                                                                                                                                                                                                                                                return NextResponse.json(
                                                                                                                                                                                                                                                                                                                                                                                        failResponse(null, "Reminder already exists for this booking", "REMINDER_EXISTS"),
                                                                                                                                                                                                                                                                                                                                                                                                { status: 409 }
                                                                                                                                                                                                                                                                                                                                                                                                      )
                                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                                              // Create reminder
                                                                                                                                                                                                                                                                                                                                                                                                                  const reminder = await prisma.checkoutReminder.create({
                                                                                                                                                                                                                                                                                                                                                                                                                        data: {
                                                                                                                                                                                                                                                                                                                                                                                                                                bookingId: booking.id,
                                                                                                                                                                                                                                                                                                                                                                                                                                        userId: booking.userId,
                                                                                                                                                                                                                                                                                                                                                                                                                                                hotelId: booking.hotelId,
                                                                                                                                                                                                                                                                                                                                                                                                                                                        reminderTime: scheduledTime,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                reminderText: validated.customMessage || `Reminder: ${validated.reminderType} for booking ${booking.bookingReference}`,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          })

                                                                                                                                                                                                                                                                                                                                                                                                                                                                              // Send immediate notification if reminder is due
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if (scheduledTime <= now) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        await sendImmediateNotification(booking, validated.reminderType, validated.customMessage)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return NextResponse.json(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      successResponse(reminder, "Reminder scheduled successfully"),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            { status: 201 }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                )

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if (error instanceof z.ZodError) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return NextResponse.json(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    failResponse(null, "Invalid reminder data", "VALIDATION_ERROR"),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            { status: 400 }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          console.error("Create reminder error:", error)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return NextResponse.json(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    failResponse(null, "Internal server error", "CREATE_REMINDER_ERROR"),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          { status: 500 }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                export async function GET(req: NextRequest) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const auth = await withAuth(req)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (!auth.isValid) return auth.response!

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const { searchParams } = new URL(req.url)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const bookingId = searchParams.get('bookingId')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const status = searchParams.get('status') // 'pending', 'sent', 'cancelled'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const page = parseInt(searchParams.get('page') || '1')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const pageSize = parseInt(searchParams.get('pageSize') || '20')

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const whereConditions: any = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    OR: [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            { userId: auth.payload.userId },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    { hotel: { managerId: auth.payload.userId } },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if (bookingId) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        whereConditions.bookingId = bookingId
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (status) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      whereConditions.sent = status === 'sent'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const [reminders, totalCount] = await Promise.all([
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    prisma.checkoutReminder.findMany({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            where: whereConditions,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    include: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              booking: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          select: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        id: true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      bookingReference: true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    checkInDate: true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  checkOutDate: true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                status: true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                hotel: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            select: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          id: true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        name: true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      address: true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            orderBy: { createdAt: 'desc' },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    skip: (page - 1) * pageSize,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            take: pageSize,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        prisma.checkoutReminder.count({ where: whereConditions }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ])

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return NextResponse.json(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      successResponse({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              reminders,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      pagination: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                page,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          pageSize,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    totalCount,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              totalPages: Math.ceil(totalCount / pageSize),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        hasNext: page * pageSize < totalCount,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  hasPrev: page > 1,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      { status: 200 }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          )

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                console.error("Get reminders error:", error)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return NextResponse.json(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          failResponse(null, "Internal server error", "GET_REMINDERS_ERROR"),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                { status: 500 }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // Helper function to send immediate notifications
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      async function sendImmediateNotification(booking: any, reminderType: string, customMessage?: string) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const message = customMessage || `Reminder: ${reminderType} for your booking ${booking.bookingReference}`

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // Create notification
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            await prisma.notification.create({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                data: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      userId: booking.userId,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            type: reminderType === 'checkin' ? 'CHECK_IN_REMINDER' : 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        reminderType === 'checkout' ? 'PAYMENT_REMINDER' : 'BOOKING_CONFIRMED',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              title: `Booking ${reminderType.charAt(0).toUpperCase() + reminderType.slice(1)} Reminder`,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    message,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          data: JSON.stringify({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  bookingId: booking.id,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          bookingReference: booking.bookingReference,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  hotelName: booking.hotel.name,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          reminderType,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      })

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // Send email if configured (placeholder for email service)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          console.log(`Sending email notification to ${booking.user.email}: ${message}`)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // Background job to process scheduled reminders (call this from a cron job or background service)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          async function processScheduledReminders() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const now = new Date()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const dueReminders = await prisma.checkoutReminder.findMany({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          where: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  sent: false,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          reminderTime: { lte: now },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      include: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              booking: true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      hotel: true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                })

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for (const reminder of dueReminders) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // Send notification
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          await sendImmediateNotification(reminder.booking, reminder.reminderText)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // Mark as sent
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          await prisma.checkoutReminder.update({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    where: { id: reminder.id },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              data: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          sent: true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      sentAt: now,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        })

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                console.log(`Processed reminder ${reminder.id} for booking ${reminder.bookingId}`)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              console.error(`Failed to process reminder ${reminder.id}:`, error)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              console.error("Process scheduled reminders error:", error)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }